Datalist=list()
for (i in 1:length(Llabels)){
Datalist[[i]]=fread(Llabels[i])
Datalist[[i]]$fichier=basename(Llabels[i])
}
DataL=rbindlist(Datalist,fill=T,use.names=T)
NbFichiers=aggregate(DataL$V1,by=c(list(DataL$V7),list(DataL$fichier),length)
)
NbFichiers=aggregate(DataL$V1,by=c(list(DataL$V7),list(DataL$fichier)),length)
head(NbFichiers)
NbFichiers=aggregate(DataL2$V1,by=c(list(DataL2$V7),list(DataL2$fichier)),length)
DataL2=subset(DataL,DataL$V7!="")
test=dcast(data=DataL2,V3~V7)
NbFichiers=aggregate(DataL2$V1,by=c(list(DataL2$V7),list(DataL2$fichier)),length)
NbFichiers2=aggregate(NbFichiers$Group.2,by=list(NbFichiers$Group.1),length)
NbFichiers2
ListSp=subset(NbFichiers2$Group.1,NbFichiers2$x>5)
ListSp
ListSp=subset(NbFichiers2$Group.1,NbFichiers2$x>4)
ListSp
j=1
print(ListSp[j])
Pos=subset(DataL2,DataL2$V7==ListSp[j])
table(Pos$V3)
Truth=subset(DataL2,DataL2$V7==ListSp[j])
rm(Pos)
FPrate=mean(Truth$V3==ListSp[j])
FPrate=mean(Truth$V3!=ListSp[j])
print(paste("FP rate:",round(FPrate*100)))
print(paste("FP rate:",round(FPrate*100,1)))
head(table(Truth$V3)[order(table(Truth$V3),decreasing=T)])
Pos=subset(DataL2,DataL2$V3==ListSp[j])
FPrate=mean(Truth$V7!=ListSp[j])
FPrate=mean(Pos$V7!=ListSp[j])
print(paste("FP rate:",round(FPrate*100,1)))
head(table(Pos$V3)[order(table(Pos$V3),decreasing=T)])
head(table(Pos$V7)[order(table(Pos$V7),decreasing=T)])
for (j in 1:length(ListSp)){
print(ListSp[j])
Truth=subset(DataL2,DataL2$V7==ListSp[j])
table(Pos$V3)
FNrate=mean(Truth$V3!=ListSp[j])
print(paste("FN rate:",round(FNrate*100,1)))
head(table(Truth$V3)[order(table(Truth$V3),decreasing=T)])
Pos=subset(DataL2,DataL2$V3==ListSp[j])
FPrate=mean(Pos$V7!=ListSp[j])
print(paste("FP rate:",round(FPrate*100,1)))
head(table(Pos$V7)[order(table(Pos$V7),decreasing=T)])
}
for (j in 1:length(ListSp)){
print(ListSp[j])
Truth=subset(DataL2,DataL2$V7==ListSp[j])
table(Pos$V3)
FNrate=mean(Truth$V3!=ListSp[j])
print(paste("FN rate:",round(FNrate*100,1)))
print(head(table(Truth$V3)[order(table(Truth$V3),decreasing=T)]))
Pos=subset(DataL2,DataL2$V3==ListSp[j])
FPrate=mean(Pos$V7!=ListSp[j])
print(paste("FP rate:",round(FPrate*100,1)))
print(head(table(Pos$V7)[order(table(Pos$V7),decreasing=T)]))
}
ListSp
DataL2save=DataL2
table(DataL2$V8)
DataL2=subset(DataL2,DataL2$V8!="terr")
for (j in 1:length(ListSp)){
print(ListSp[j])
Truth=subset(DataL2,DataL2$V7==ListSp[j])
table(Pos$V3)
FNrate=mean(Truth$V3!=ListSp[j])
print(paste("FN rate:",round(FNrate*100,1)))
print(head(table(Truth$V3)[order(table(Truth$V3),decreasing=T)]))
Pos=subset(DataL2,DataL2$V3==ListSp[j])
FPrate=mean(Pos$V7!=ListSp[j])
print(paste("FP rate:",round(FPrate*100,1)))
print(head(table(Pos$V7)[order(table(Pos$V7),decreasing=T)]))
}
for (j in 1:length(ListSp)){
print(ListSp[j])
Truth=subset(DataL2,DataL2$V7==ListSp[j])
table(Pos$V3)
FNrate=mean(Truth$V3!=ListSp[j])
print(paste("FN rate:",round(FNrate*100,1)))
print(head(table(Truth$V3)[order(table(Truth$V3),decreasing=T)]))
Pos=subset(DataL2,DataL2$V3==ListSp[j])
FPrate=mean(Pos$V7!=ListSp[j])
print(paste("FP rate:",round(FPrate*100,1)))
print(head(table(Pos$V7)[order(table(Pos$V7),decreasing=T)]))
}
library(data.table)
Dir="C:/Users/yvesb/Documents/Tadarida/Dbas_deepL/SampleV2/PasEncore220310"
Dir="C:/Users/yvesb/Documents/Tadarida/Dbas_deepL/SampleV3/tdaudatxt_GSampleV3_Part1_premier_test"
TableSpeciesSel=NA
#RemainDir="C:/Users/yvesb/Downloads/SampleV2_P2H2/Remain1"
RemainDir=NA
NperSlot=10
Files=list.files(Dir,full.names=T)
Sub=substr(basename(Files),1,24)
if(!is.na(RemainDir)){
FilesR=list.files(RemainDir,full.names=T)
SubF=substr(basename(FilesR),1,24)
Files=subset(Files,Sub %in% SubF)
}
datalist=list()
for (i in 1:length(Files)){
test=fread(Files[i])
if(nrow(test)>0){
datalist[[i]]=test
datalist[[i]]$file=basename(Files[i])
}
}
dataAll=rbindlist(datalist)
if(grepl(" - ",dataAll$V3)){
dataAll$species=tstrsplit(dataAll$V3,split=" ")[[1]]
dataAll$confiance=as.numeric(tstrsplit(dataAll$V3,split=" ")[[2]])/100
dataAll$frequence=as.numeric(tstrsplit(dataAll$V3,split=" ")[[4]])
}else{
dataAll$species=dataAll$V3
dataAll$confiance=dataAll$V4
}
(grepl(" - ",dataAll$V3))
(grepl(" - ",dataAll$V3[1]))
dataAll$species=tstrsplit(dataAll$V3,split=" ")[[1]]
dataAll$confiance=as.numeric(tstrsplit(dataAll$V3,split=" ")[[2]])/100
dataAll$frequence=as.numeric(tstrsplit(dataAll$V3,split=" ")[[4]])
dataAll=rbindlist(datalist)
if(grepl(" - ",dataAll$V3[1])){
dataAll$species=tstrsplit(dataAll$V3,split=" ")[[1]]
dataAll$confiance=as.numeric(tstrsplit(dataAll$V3,split=" ")[[2]])/100
dataAll$frequence=as.numeric(tstrsplit(dataAll$V3,split=" ")[[4]])
}else{
dataAll$species=dataAll$V3
dataAll$confiance=dataAll$V4
}
table(dataAll$species)
head(dataAll)
datalist=list()
for (i in 1:length(Files)){
test=fread(Files[i])
if(nrow(test)>0){
datalist[[i]]=test
datalist[[i]]$file=basename(Files[i])
}
}
dataAll=rbindlist(datalist)
head(dataAll)
(grepl(" - ",dataAll$V3[1]))
dataAll$species=tstrsplit(dataAll$V3,split=" ")[[1]]
head(dataAll$species)
dataAll=rbindlist(datalist)
if(grepl(" - ",dataAll$V3[1])){
dataAll$species=tstrsplit(dataAll$V3,split=" ")[[1]]
dataAll$confiance=as.numeric(tstrsplit(dataAll$V3,split=" ")[[2]])/100
dataAll$frequence=as.numeric(tstrsplit(dataAll$V3,split=" ")[[4]])
}else{
dataAll$species=dataAll$V3
dataAll$confiance=dataAll$V4
}
table(dataAll$species)
Files=list.files(Dir,full.names=T,pattern="tdauda")
library(data.table)
Dir="C:/Users/yvesb/Documents/Tadarida/Dbas_deepL/SampleV2/PasEncore220310"
Dir="C:/Users/yvesb/Documents/Tadarida/Dbas_deepL/SampleV3/tdaudatxt_GSampleV3_Part1_premier_test"
#Dir="C:/Users/yvesb/Downloads/SampleV2_P2H2/BN"
TableSpeciesSel=fread("speciesBN_2022-09-17_sel.csv")
TableSpeciesSel=NA
#RemainDir="C:/Users/yvesb/Downloads/SampleV2_P2H2/Remain1"
RemainDir=NA
NperSlot=10
Files=list.files(Dir,full.names=T,pattern="tdauda")
Sub=substr(basename(Files),1,24)
if(!is.na(RemainDir)){
FilesR=list.files(RemainDir,full.names=T)
SubF=substr(basename(FilesR),1,24)
Files=subset(Files,Sub %in% SubF)
}
datalist=list()
for (i in 1:length(Files)){
test=fread(Files[i])
if(nrow(test)>0){
datalist[[i]]=test
datalist[[i]]$file=basename(Files[i])
}
}
dataAll=rbindlist(datalist)
if(grepl(" - ",dataAll$V3[1])){
dataAll$species=tstrsplit(dataAll$V3,split=" ")[[1]]
dataAll$confiance=as.numeric(tstrsplit(dataAll$V3,split=" ")[[2]])/100
dataAll$frequence=as.numeric(tstrsplit(dataAll$V3,split=" ")[[4]])
}else{
dataAll$species=dataAll$V3
dataAll$confiance=dataAll$V4
}
table(dataAll$species)
test=as.data.frame(table(dataAll$species))
fwrite(test,paste0("species_",Sys.Date(),".csv"),sep=";")
ClassConf=round(dataAll$confiance*10)
table(ClassConf)
#
Synthesis=aggregate(dataAll$file,by=list(dataAll$species),length)
Synthesis2=aggregate(dataAll$confiance,by=list(dataAll$species),median)
Synthesis$confiance=Synthesis2$x
fwrite(Synthesis,paste0(Dir,".csv"),sep=";")
dataAll$confianceR=rank(dataAll$confiance)
#dataAll$confianceClass=floor(dataAll$confianceR*10/max(dataAll$confianceR))
dataAll$confianceClass=floor(dataAll$confiance*10)
table(dataAll$confianceClass)
if(is.na(TableSpeciesSel)){
SpeciesMax=Synthesis$Group.1
}else{
SpeciesMax=subset(TableSpeciesSel$Var1,TableSpeciesSel$Sel=="x")
}
SpeciesSel=vector()
DirSel=vector()
SpeciesSel=vector()
Ndir=0
i=0
while((length(Ndir)<(NperSlot/2))&(i<(length(SpeciesMax)*2))){
i=i+1
Speciesi=sample(SpeciesMax,1)
print(Speciesi)
datai=subset(dataAll,dataAll$species==Speciesi)
if(nrow(datai)>0){
SpeciesSel=c(SpeciesSel,Speciesi)
dataimax=subset(datai,datai$confiance==max(datai$confiance))
DirSeli=sample(unique(dataimax$file),1)
print(DirSeli)
DirSel=c(DirSel,DirSeli)
Ndir=unique(DirSel)
print(length(Ndir))
}
}
DataMax=data.frame(DirSel,SpeciesSel,type="max")
type=rep("max",nrow(DataMax))
while(length(Ndir)<(NperSlot)){
Speciesi=sample(Synthesis$Group.1,1)
print(Speciesi)
datai=subset(dataAll,dataAll$species==Speciesi)
Classi=sample(c(0:10),1)
print(Classi)
dataic=subset(datai,datai$confianceClass==Classi)
if(nrow(dataic)>0){
SpeciesSel=c(SpeciesSel,Speciesi)
type=c(type,Classi)
DirSeli=sample(unique(dataic$file),1)
print(DirSeli)
DirSel=c(DirSel,DirSeli)
Ndir=unique(DirSel)
print(length(Ndir))
}
}
dataClass=data.frame(SpeciesSel,DirSel,type)
length(unique(DirSel))
fwrite(dataClass,paste0(Dir,"_",Sys.Date(),"_selected.csv"),sep=";")
table(dataAll$species)
print(head(table(dataAll$species)[order(table(dataAll$species),decreasing=T)],20))
BNinitDir="C:/Users/yvesb/Documents/Tadarida/Dbas_deepL/SampleV3/bnauda_p1"
BNnew=paste0(BNinitDir,"_auda")
dir.create(BNnew)
Files=list.files(BNinitDir,full.names=T)
datalist=list()
for (i in 1:length(Files)){
test=fread(Files[i])
if(nrow(test)>0){
SpInfo=tstrsplit(test$V3,split=" ")
SpCode=paste0(substr(SpInfo[[1]],1,3),substr(SpInfo[[2]],1,4))
table(SpCode)
Confiance=round(test$V4*100)
test$V3=paste(SpCode,"-",Confiance)
fwrite(test,paste0(BNnew,"/",basename(Files[i])),sep="\t")
datalist[[i]]=test
datalist[[i]]$file=basename(Files[i])
}
}
dataAll=rbindlist(datalist)
library(data.table)
BNinitDir="C:/Users/yvesb/Documents/Tadarida/Dbas_deepL/SampleV3/bnauda_p1"
BNnew=paste0(BNinitDir,"_auda")
dir.create(BNnew)
Files=list.files(BNinitDir,full.names=T)
datalist=list()
for (i in 1:length(Files)){
test=fread(Files[i])
if(nrow(test)>0){
SpInfo=tstrsplit(test$V3,split=" ")
SpCode=paste0(substr(SpInfo[[1]],1,3),substr(SpInfo[[2]],1,4))
table(SpCode)
Confiance=round(test$V4*100)
test$V3=paste(SpCode,"-",Confiance)
fwrite(test,paste0(BNnew,"/",basename(Files[i])),sep="\t")
datalist[[i]]=test
datalist[[i]]$file=basename(Files[i])
}
}
dataAll=rbindlist(datalist)
table(dataAll$V4)
table(dataAll$V3)
table(dataAll$V2)
table(dataAll$V1)
table(substr(dataAll$V3,1,7))
table(substr(dataAll$V3,1,7)[order(substr(dataAll$V3,1,7),decreasing = T)])
table(substr(dataAll$V3,1,7))[order(substr(dataAll$V3,1,7),decreasing = T)]
table(substr(dataAll$V3,1,7))[order(table(substr(dataAll$V3,1,7))
,decreasing = T)]
library(data.table)
Dir="C:/Users/yvesb/Downloads/GSampleV3_Part1/bnauda_p1_auda"
Dir="C:/Users/yvesb/Documents/Tadarida/Dbas_deepL/SampleV3/tdaudatxt_GSampleV3_Part1_premier_test"
#Dir="C:/Users/yvesb/Downloads/SampleV2_P2H2/BN"
TableSpeciesSel=fread("speciesBN_2022-09-17_sel.csv")
TableSpeciesSel=NA
RemainDir="C:/Users/yvesb/Downloads/GSampleV3_Part1/PA_221020"
NperSlot=10
Dir="C:/Users/yvesb/Downloads/GSampleV3_Part1/bnauda_p1_auda"
Files=list.files(Dir,full.names=T,pattern="tdauda")
Files=list.files(Dir,full.names=T)
head(Files)
#,pattern="tdauda")
Sub=substr(basename(Files),1,24)
Sub
if(!is.na(RemainDir)){
FilesR=list.files(RemainDir,full.names=T)
SubF=substr(basename(FilesR),1,24)
Files=subset(Files,Sub %in% SubF)
}
datalist=list()
for (i in 1:length(Files)){
test=fread(Files[i])
if(nrow(test)>0){
datalist[[i]]=test
datalist[[i]]$file=basename(Files[i])
}
}
dataAll=rbindlist(datalist)
if(grepl(" - ",dataAll$V3[1])){
dataAll$species=tstrsplit(dataAll$V3,split=" ")[[1]]
dataAll$confiance=as.numeric(tstrsplit(dataAll$V3,split=" ")[[2]])/100
dataAll$frequence=as.numeric(tstrsplit(dataAll$V3,split=" ")[[4]])
}else{
dataAll$species=dataAll$V3
dataAll$confiance=dataAll$V4
}
(grepl(" - ",dataAll$V3[1]))
dataAll$species=tstrsplit(dataAll$V3,split=" ")[[1]]
dataAll$confiance=as.numeric(tstrsplit(dataAll$V3,split=" ")[[2]])/100
head(dataAll$V3)
dataAll$confiance=as.numeric(tstrsplit(dataAll$V3,split=" ")[[3]])/100
dataAll$confiance
dataAll$frequence=""
dataAll$frequence=0
table(dataAll$species)
test=as.data.frame(table(dataAll$species))
fwrite(test,paste0("species_",Sys.Date(),".csv"),sep=";")
ClassConf=round(dataAll$confiance*10)
table(ClassConf)
#
Synthesis=aggregate(dataAll$file,by=list(dataAll$species),length)
Synthesis2=aggregate(dataAll$confiance,by=list(dataAll$species),median)
Synthesis$confiance=Synthesis2$x
fwrite(Synthesis,paste0(Dir,".csv"),sep=";")
dataAll$confianceR=rank(dataAll$confiance)
#dataAll$confianceClass=floor(dataAll$confianceR*10/max(dataAll$confianceR))
dataAll$confianceClass=floor(dataAll$confiance*10)
table(dataAll$confianceClass)
(is.na(TableSpeciesSel))
SpeciesMax=Synthesis$Group.1
SpeciesMax
SpeciesSel=vector()
DirSel=vector()
SpeciesSel=vector()
Ndir=0
i=0
((length(Ndir)<(NperSlot/2))&(i<(length(SpeciesMax)*2)))
i=i+1
dataNum=aggregate(dataAll$V1,by=list(dataAll$file),length)
dataNum
dataNum$Rank=rank(dataNum$x)
dataNum$Rank
Parcimi=sample.int(max(dataNum$Rank))
Parcimi=sample.int(max(dataNum$Rank),1)
plot(dataNum$x,dataNum$Rank)
SiteP=subset(dataNum$Group.1,dataNum$Rank<=Parcimi)
datai=subset(dataAll,dataAll$file %in% SiteP)
table(datai$species)
SpeciesP=unique(datai$species)
SpeciesP
SpeciesPM=subset(SpeciesP %in% SpeciesMax)
SpeciesPM=subset(SpeciesP,SpeciesP %in% SpeciesMax)
Speciesi=sample(SpeciesPM,1)
print(Speciesi)
datai=subset(dataAll,dataAll$species==Speciesi)
(nrow(datai)>0)
SpeciesSel=c(SpeciesSel,Speciesi)
dataimax=subset(datai,datai$confiance==max(datai$confiance))
dataimax
DirSeli=sample(unique(dataimax$file),1)
print(DirSeli)
DirSel=c(DirSel,DirSeli)
Ndir=unique(DirSel)
print(length(Ndir))
SpeciesSel=vector()
DirSel=vector()
SpeciesSel=vector()
Ndir=0
i=0
while((length(Ndir)<(NperSlot/2))&(i<(length(SpeciesMax)*2))){
i=i+1
Parcimi=sample.int(max(dataNum$Rank),1)
SiteP=subset(dataNum$Group.1,dataNum$Rank<=Parcimi)
datai=subset(dataAll,dataAll$file %in% SiteP)
table(datai$species)
SpeciesP=unique(datai$species)
SpeciesPM=subset(SpeciesP,SpeciesP %in% SpeciesMax)
if(length(SpeciesPM)>0){
Speciesi=sample(SpeciesPM,1)
print(Speciesi)
datai=subset(dataAll,dataAll$species==Speciesi)
if(nrow(datai)>0){
SpeciesSel=c(SpeciesSel,Speciesi)
dataimax=subset(datai,datai$confiance==max(datai$confiance))
DirSeli=sample(unique(dataimax$file),1)
print(DirSeli)
DirSel=c(DirSel,DirSeli)
Ndir=unique(DirSel)
print(length(Ndir))
}
}
}
DataMax=data.frame(DirSel,SpeciesSel,type="max")
type=rep("max",nrow(DataMax))
Parcimi=sample.int(max(dataNum$Rank),1)
SiteP=subset(dataNum$Group.1,dataNum$Rank<=Parcimi)
datai=subset(dataAll,dataAll$file %in% SiteP)
table(datai$species)
SpeciesP=unique(datai$species)
SpeciesPM=subset(SpeciesP,SpeciesP %in% SpeciesMax)
(length(SpeciesPM)>0)
Speciesi=sample(SpeciesPM,1)
print(Speciesi)
datai=subset(dataAll,dataAll$species==Speciesi)
Classi=sample(c(0:10),1)
Classi
print(Classi)
dataic=subset(datai,datai$confianceClass==Classi)
while(length(Ndir)<(NperSlot)){
Parcimi=sample.int(max(dataNum$Rank),1)
SiteP=subset(dataNum$Group.1,dataNum$Rank<=Parcimi)
datai=subset(dataAll,dataAll$file %in% SiteP)
table(datai$species)
SpeciesP=unique(datai$species)
SpeciesPM=subset(SpeciesP,SpeciesP %in% SpeciesMax)
if(length(SpeciesPM)>0){
Speciesi=sample(SpeciesPM,1)
print(Speciesi)
datai=subset(dataAll,dataAll$species==Speciesi)
Classi=sample(c(0:10),1)
print(Classi)
dataic=subset(datai,datai$confianceClass==Classi)
if(nrow(dataic)>0){
stop()
SpeciesSel=c(SpeciesSel,Speciesi)
type=c(type,Classi)
DirSeli=sample(unique(dataic$file),1)
print(DirSeli)
DirSel=c(DirSel,DirSeli)
Ndir=unique(DirSel)
print(length(Ndir))
}
}
}
#stop()
SpeciesSel=c(SpeciesSel,Speciesi)
type=c(type,Classi)
DirSeli=sample(unique(dataic$file),1)
DirSeli
print(DirSeli)
DirSel=c(DirSel,DirSeli)
Ndir=unique(DirSel)
print(length(Ndir))
while(length(Ndir)<(NperSlot)){
Parcimi=sample.int(max(dataNum$Rank),1)
SiteP=subset(dataNum$Group.1,dataNum$Rank<=Parcimi)
datai=subset(dataAll,dataAll$file %in% SiteP)
table(datai$species)
SpeciesP=unique(datai$species)
SpeciesPM=subset(SpeciesP,SpeciesP %in% SpeciesMax)
if(length(SpeciesPM)>0){
Speciesi=sample(SpeciesPM,1)
print(Speciesi)
datai=subset(dataAll,dataAll$species==Speciesi)
Classi=sample(c(0:10),1)
print(Classi)
dataic=subset(datai,datai$confianceClass==Classi)
if(nrow(dataic)>0){
#stop()
SpeciesSel=c(SpeciesSel,Speciesi)
type=c(type,Classi)
DirSeli=sample(unique(dataic$file),1)
print(DirSeli)
DirSel=c(DirSel,DirSeli)
Ndir=unique(DirSel)
print(length(Ndir))
}
}
}
dataClass=data.frame(SpeciesSel,DirSel,type)
length(unique(DirSel))
fwrite(dataClass,paste0(Dir,"_",Sys.Date(),"_selected.csv"),sep=";")
table(dataAll$species)
print(head(table(dataAll$species)[order(table(dataAll$species),decreasing=T)],20))
dataClass=dataClass[order(dataClass$DirSel),]
length(unique(DirSel))
fwrite(dataClass,paste0(Dir,"_",Sys.Date(),"_selected.csv"),sep=";")
